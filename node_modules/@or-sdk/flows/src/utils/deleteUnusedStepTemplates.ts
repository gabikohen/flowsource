import { Flow } from '@or-sdk/deployer';
import { listUnusedStepTemplates } from '../utils';
import { StepTemplateToDelete } from '../types';

function deleteUnusedStepTemplates(source: Flow, stepTemplates: StepTemplateToDelete[] = []): Flow {
  const unusedStepTemplates = listUnusedStepTemplates(source);
  const stepTemplatesToDelete = stepTemplates.length ?
    unusedStepTemplates.filter(unusedTemplate =>
      stepTemplates.find(template => unusedTemplate.id === template.id)
    ) :
    unusedStepTemplates;
  const stepTemplatesInSource = source?.data?.stepTemplates || [];

  return {
    ...source,
    data: {
      ...source.data,
      stepTemplates: stepTemplatesInSource.filter(template =>
        !stepTemplatesToDelete.find(unusedTemplate => unusedTemplate.id === template.id)
      ),
    },
  };
}

export default deleteUnusedStepTemplates;
